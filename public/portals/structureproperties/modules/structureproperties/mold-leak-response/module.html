<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Training Module</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  body {
    margin: 0;
    background: radial-gradient(1200px 600px at 20% -10%, #0b1c34, #020617);
    color: #e5e7eb;
    font-family: system-ui, -apple-system, Segoe UI, Roboto;
  }

  .wrap {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }

  h1 {
    font-size: 22px;
    margin: 0;
    font-weight: 900;
  }

  .right {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .pill {
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 800;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.14);
  }

  .pill.inprogress { color: #60a5fa; }
  .pill.complete { color: #22c55e; }

  .btn {
    padding: 10px 14px;
    border-radius: 12px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.14);
    color: #e5e7eb;
    font-weight: 800;
    text-decoration: none;
  }

  .player {
    margin-top: 14px;
    border-radius: 18px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.14);
    background: black;
  }

  video {
    width: 100%;
    display: block;
  }

  .progress {
    display: flex;
    gap: 10px;
    align-items: center;
    font-size: 12px;
    opacity: 0.9;
    margin-top: 10px;
  }

  iframe {
    width: 100%;
    height: 520px;
    border: none;
    margin-top: 18px;
    border-radius: 16px;
    background: rgba(255,255,255,0.04);
  }
</style>
</head>

<body>
<div class="wrap">

  <header>
    <h1 id="title">Mold & Leak Response</h1>
    <div class="right">
      <span id="status" class="pill">NOT STARTED</span>
      <a class="btn" href="../../../../index.html">Back</a>
    </div>
  </header>

  <div class="player">
    <video id="video" controls preload="metadata">
      <source src="https://ogg0ove5njg0ajav.public.blob.vercel-storage.com/Copy%20of%20Mold%20and%20Leak.mp4" type="video/mp4">
    </video>
  </div>

  <div class="progress">
    <div id="watch">Watch time: 00:00</div>
    <div id="wrong">Wrong: 0</div>
    <div id="checkpoints">Checkpoints: 0 / 2</div>
  </div>

  <iframe id="quiz" src="quiz.html"></iframe>

</div>

<script>
  const video = document.getElementById("video");
  const statusPill = document.getElementById("status");
  const watchEl = document.getElementById("watch");
  const wrongEl = document.getElementById("wrong");
  const cpEl = document.getElementById("checkpoints");

  const checkpoints = [90, 210]; // seconds
  let passed = 0;
  let wrong = 0;
  let maxAllowed = 0;
  let watchTime = 0;
  let lastTick = Date.now();
  let completed = false;

  function fmt(t) {
    const m = Math.floor(t / 60).toString().padStart(2, "0");
    const s = Math.floor(t % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
  }

  function refreshUI() {
    watchEl.textContent = "Watch time: " + fmt(watchTime);
    wrongEl.textContent = "Wrong: " + wrong;
    cpEl.textContent = `Checkpoints: ${passed} / ${checkpoints.length}`;

    if (completed) {
      statusPill.textContent = "COMPLETED";
      statusPill.className = "pill complete";
    } else if (watchTime > 0) {
      statusPill.textContent = "IN PROGRESS";
      statusPill.className = "pill inprogress";
    }
  }

  video.addEventListener("timeupdate", () => {
    const now = Date.now();
    watchTime += (now - lastTick) / 1000;
    lastTick = now;

    checkpoints.forEach((t, i) => {
      if (video.currentTime >= t && passed === i) {
        video.pause();
      }
    });

    maxAllowed = Math.max(maxAllowed, video.currentTime);
    refreshUI();
  });

  video.addEventListener("seeking", () => {
    if (video.currentTime > maxAllowed + 0.25) {
      video.currentTime = maxAllowed;
    }
  });

  window.addEventListener("message", e => {
    if (e.data?.type === "qs_quiz_completed") {
      passed++;
      wrong += e.data.wrongAnswers || 0;
      maxAllowed = checkpoints[passed - 1] + 0.5;

      if (passed >= checkpoints.length) {
        completed = true;
      }

      refreshUI();
    }
  });

  refreshUI();
</script>

</body>
</html>
